<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extract Customer Code from Invoice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #result { margin-top: 20px; font-weight: bold; }
        #fileInput { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2>Upload Invoice (PDF or Image)</h2>
    <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg">
    <div id="result"></div>

    <script>
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const resultDiv = document.getElementById('result');
            resultDiv.textContent = "Processing...";

            if (file.type === 'application/pdf') {
                extractTextFromPDF(file);
            } else {
                extractTextFromImage(file);
            }
        });

        // Extract text from PDF
        async function extractTextFromPDF(file) {
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                const pdf = await loadingTask.promise;

                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ');
                }

                const customerCode = extractCustomerCode(fullText);
                displayResult(customerCode);
            } catch (error) {
                document.getElementById('result').textContent = "Error reading PDF: " + error.message;
            }
        }

        // Extract text from image (OCR)
        async function extractTextFromImage(file) {
            try {
                const { data: { text } } = await Tesseract.recognize(file, 'eng+ara'); // Supports Arabic
                const customerCode = extractCustomerCode(text);
                displayResult(customerCode);
            } catch (error) {
                document.getElementById('result').textContent = "Error processing image: " + error.message;
            }
        }

        // Improved regex to match Customer Code
        function extractCustomerCode(text) {
            // Try English pattern first: "Customer Code" followed by numbers
            let match = text.match(/Customer Code\s*(\d+)/i);
            if (match) return match[1];

            // Try Arabic pattern: "رمز العميل" followed by numbers
            match = text.match(/رمز العميل\s*(\d+)/);
            if (match) return match[1];

            // Fallback: Search for a 8-digit number near "Code" or "رمز"
            match = text.match(/(Code|رمز)[\s:]*(\d{8})/i);
            if (match) return match[2];

            return "Not found (check console for raw text)";
        }

        // Display result
        function displayResult(customerCode) {
            const resultDiv = document.getElementById('result');
            if (customerCode === "Not found (check console for raw text)") {
                resultDiv.innerHTML = `Customer Code: <span style="color: red;">${customerCode}</span>`;
                console.log("Raw extracted text:", text); // Debugging
            } else {
                resultDiv.innerHTML = `Customer Code: <span style="color: green;">${customerCode}</span>`;
            }
        }
    </script>
</body>
</html>